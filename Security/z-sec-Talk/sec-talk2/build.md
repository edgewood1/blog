====================================
how did malwre get into the build cycle?  
it was deployed into the build env.
the cycle was hijacked
it's purpsoe was to create a backdoor wihtout arousing the suspicion of the development team. 

what it (SUNSPOT) does
- inserts the SUNBURST backdoor into software builds of the SolarWinds Orion IT management product.
- monitors running processes for those involved in compilation of the Orion product and replaces one of the source files to include the SUNBURST backdoor code into update package

SUNSPOT
- contains safeguards to prevent failed builds, which would alert developers to the adversary’s presence. 
- safeguards to ensure it was properly inserted and remained undetected
- it prioritized operational security to avoid revealing their presence in the build env 

Technical Analysis
- creates / delivers an on-disk executable named taskhostsvc.exc whose build date is 2-20-20 
- it persisted via a scheduled task set to execute when the host boots. 
- - it has teh SeDebugPrivilege grant, which allows it to read memory of other processes.
- it uses this to watch for MsBuild.exe (a visual studio devleopment component execution
- when it sees it, it modifies the target source code before the compiler has a chance to read it.
- sunpot then looks for a specific orion software source code component and replaces it with one tha twill inject sunburst during the build process. 
- sunsport has validation checks to ensure no build errors are triggered during the build

RAindrop / tear drop

INITIALIZE
- it ensures only one instance is running. 

- It then creates an encrypted log file at C:\Windows\Temp\vmware-vmdmp.log. 
            - Individual log entries are encrypted with the stream cipher RC4, using the hard-coded key FC F3 2A 83 E5 F6 D0 24 A6 BF CE 88 30 C2 48 E7. 
            - Throughout execution, SUNSPOT will log errors to this file, along with other deployment information. Log entries are delineated by the hex string 32 78 A5 E7 1A 79 91 AC and begin with the number of seconds elapsed since the first log line. Most log lines corresponding to an error contain a step number (e.g., Step19) requiring knowledge of the malware to understand their meaning. These steps and their mapping to the malware actions are provided at the end of this blog. The step numbering does not follow the actual execution order, suggesting the calls to the logging function were added by the developers during the creation of the malware as they progressed and needed to focus their efforts on debugging one part of the code. An extract of a log file generated by SUNSPOT in a test environment is given below.


- The malware then grants itself debugging privileges by modifying its security token to add SeDebugPrivilege. This step is a prerequisite for the remainder of SUNSPOT’s execution, which involves reading other processes’ memory. 

BUILD HIJACKING STEPS
====================================
Monitoring of Running Software Build Processes
- After initialization, SUNSPOT monitors running processes for instances of MsBuild.exe, which is part of Microsoft Visual Studio development tools. 
- Copies of MsBuild.exe are identified by hashing the name of each running process and comparing it to the corresponding value, 0x53D525. The hashing algorithm used for the comparison is ElfHash and is provided in Python in Figure 1.

- When SUNSPOT finds an MsBuild.exe process, it will spawn a new thread to determine if the Orion software is being built and, if so, hijack the build operation to inject SUNBURST. The monitoring loop executes every second, allowing SUNSPOT to modify the target source code before it has been read by the compiler.

- Although the mutex created during the initialization should already prevent multiple process monitoring loops from running, the malware checks for the presence of a second mutex — {56331e4d-76a3-0390-a7ee-567adf5836b7}. 
- If this mutex is found, the backdoor interprets it as a signal to quit, waits for the completion of its currently running backdoor injection threads, and exits. This mutex was likely intended to be used by StellarParticle operators to discreetly stop the malware, instead of using a riskier method such as killing the process. 
- Stopping SUNSPOT in the middle of its operation could result in unfinished tampering of the Orion source code, and lead to Orion build errors that SolarWinds developers would investigate, revealing the adversary’s presence.

COMMAND LINE ARGUMENTS Extraction from Process Memory
====================================
- The malware extracts the command-line arguments for each running MsBuild.exe process from the virtual memory using a methodology similar to one publicly documented1.

- A call to NtQueryInformationProcess allows the adversary to obtain a pointer to the remote process’s Process Environment Block (PEB), which contains a pointer to a _RTL_USER_PROCESS_PARAMETERS structure. The latter is read to get the full command line passed to the MsBuild.exe process.

- The command line is then parsed to extract individual arguments, and SUNSPOT looks for the directory path of the Orion software Visual Studio solution. This value is hard-coded in the binary, in an encrypted form using AES128-CBC, whose parameters are given below. The same material is used for all of the blobs encrypted with AES in the binary.

key = FC F3 2A 83 E5 F6 D0 24 A6 BF CE 88 30 C2 48 E7 (same as the RC4 key)

iv  = 81 8C 85 49 B9 00 06 78 0B E9 63 60 26 64 B2 DA

The key and initialization vector (IV) are not unique and can be independently found in other binary samples of several popular video games. It is plausible the material was chosen on purpose in order to make static detections on the values impractical.

Orion Source Code Replacement
When SUNSPOT finds the Orion solution file path in a running MsBuild.exe process, it replaces a source code file in the solution directory, with a malicious variant to inject SUNBURST while Orion is being built. While SUNSPOT supports replacing multiple files, the identified copy only replaces InventoryManager.cs. 

The malicious source code for SUNBURST, along with target file paths, are stored in AES128-CBC encrypted blobs and are protected using the same key and initialization vector.

As causing build errors would very likely prompt troubleshooting actions from the Orion developers and lead to the adversary’s discovery, the SUNSPOT developers included a hash verification check, likely to ensure the injected backdoored code is compatible with a known source file, and also avoid replacing the file with garbage data from a failed decryption. In the exemplar SUNSPOT sample, the MD5 hash for the backdoored source code is 5f40b59ee2a9ac94ddb6ab9e3bd776ca.

If the decryption of the parameters (target file path and replacement source code) is successful and if the MD5 checks pass, SUNSPOT proceeds with the replacement of the source file content. The original source file is copied with a .bk extension (e.g., InventoryManager.bk), to back up the original content. The backdoored source is written to the same filename, but with a .tmp extension (e.g., InventoryManager.tmp), before being moved using MoveFileEx to the original filename (InventoryManager.cs). After these steps, the source file backdoored with SUNBURST will then be compiled as part of the standard process.

SUNSPOT appends an entry in the log file with the date and time of the backdoor attempt and waits for the MsBuild.exe process to exit before restoring the original source code and deleting the temporary InventoryManager.bk file. If the Orion solution build is successful, it is backdoored with SUNBURST.

SUNBURST Source Code
====================================
The source code of SUNBURST was likely sanitized before being included in SUNSPOT. The use of generic variable names, pre-obfuscated strings, and the lack of developer comments or disabled code is similar to what could be obtained after decompiling a backdoored Orion binary, as illustrated in Figure 2, which provides a comparison between the injected source code (top) and a decompilation output (bottom).

private static class ProcessTracker....
- CHECK THIS OUT !!!! - differenes between injected code and non-injected source cod e

Figure 2. Comparison between injected source code (top) and decompiled using DnSpy (bottom)

In order to remove compilation warnings that could be generated by the adversary’s own code — which could alert the SolarWinds developers — StellarParticle made their edits within #pragma warning disable and #pragma warning restore statements, hinting at what parts were edited. In particular, SUNSPOT’s entry point was added to the legitimate Orion software RefreshInternal function by adding the following try/catch block:

try {   if (!OrionImprovementBusinessLayer.IsAlive) {

       Thread th = new Thread(OrionImprovementBusinessLayer.Initialize)

           { IsBackground = true };

       th.Start();

   }

} catch (Exception) {

}

Tactics, Techniques and Procedures (TTPs)
====================================
The following TTPs may be used to characterize the SUNSPOT activity described in this blog:

Persistence using scheduled tasks, triggered at boot time
Use of AES128-CBC to protect the targeted source code files and the backdoored source code file in the binary
Use of RC4 encryption with a hard-coded key to protect the log file entries
Log entries from different executions of the malware that are separated with a hard-coded value 32 78 A5 E7 1A 79 91 AC
Log file creation in the system temp directory C:\Windows\Temp\vmware-vmdmp.log masquerading as a legitimate VMWare log file
Detection of the targeted Visual Studio solution build by reading the virtual memory of MsBuild.exe processes, looking for the targeted solution filename
Access to the remote process arguments made via the remote process’s PEB structure
Replacement of source code files during the build process, before compilation, by replacing file content with another version containing SUNBURST
Insertion of the backdoor code within #pragma statements disabling and restoring warnings, to prevent the backdoor code lines from appearing in build logs
Check of the MD5 hashes of the original source code and of the backdoored source code to ensure the tampering will not cause build errors
Attempt to open a non-existing mutex to detect when the malware operators want the backdoor to stop execution and safely exit
 
ATT&CK Framework
The following table maps reported SUNSPOT TTPs to the MITRE ATT&CK® framework.
====================================

Tactic	Technique	Observable
- Reconnaissance	T1592.002 Gather Victim Host Information – Software	StellarParticle had an understanding of the Orion build chain before SUNSPOT was developed to tamper with it.

- Resource Development	T1587.001 Develop Capabilities – Malware	SUNSPOT was weaponized to specifically target the Orion build to replace one source code file and include the SUNBURST backdoor.

- Persistence	T1053.005 Scheduled Task	SUNSPOT is persisted in a scheduled task set to execute after the host has booted.
Defense Evasion	T1140 Deobfuscate/Decode Information	The configuration in SUNSPOT is encrypted using AES128-CBC. It contains the replacement source code, the targeted Visual Studio solution file name, and targeted source code file paths relative to the solution directory.

- T1027 Obfuscated Files or Information	The log file SUNSPOT writes is encrypted using RC4.

- T1480 Execution Guardrails	The replacement of source code is done only if the MD5 checksums of both the original source code file and backdoored replacement source code match hardcoded values.
- T1036 Masquerading	SUNSPOT masquerades as a legitimate Windows Binary, and writes its logs in a fake VMWare log file.

- Discovery	T1057 Process Discovery	SUNSPOT monitors running processes looking for instances of MsBuild.exe.
- Impact	T1565.001 Data Manipulation Stored – Data Manipulation	Modification of the Orion source code to inject SUNBURST.


Logged Steps and Corresponding Errors
====================================
The following table provides a mapping of the step numbers found in the log file to the actual action performed by SUNSPOT. The step numbering does not reflect the actual execution order. Some values are also missing.

Step In Log File	Meaning
START	Logged after the initialization has completed successfully
Step1	Original file cannot be restored after tampering with the build process
Step2	Could not decrypt one of the targeted source code file’s path (relative to the solution directory)
Step3	Could not create the file path for the targeted source code file
Step4	Could not get the size of the original source code file
Step5	Computation of the MD5 hash of the original source file failed
Step6	There was a mismatch between the expected target original source code file MD5 hash and the expected value
Step7	Could not successfully decrypt the backdoored source code
Step8	Computation of the MD5 hash of the backdoored source code failed
Step9	There was a mismatch between the expected backdoored source code data MD5 hash and the expected value
Step10	Could not create backup of the original source code file
Step11	Could not write the backdoored source code to disk (in the .tmp file)
Step12	Could not copy the temporary file with the backdoored source code (with the .tmp extension) to the path of the original source
Step14	Could not read the MsBuild.exe process memory to resolve its command-line arguments
Step15	The returned PEB address for the remote process is zero
Step16	Calling NtQueryInformationProcess failed
Step17	Could not create a handle to the MsBuild.exe process with SYNCHRONIZE access
Step18	Could not successfully wait for the MsBuild.exe process termination
Step19	Obtention of the address of the NtQueryInformationProcess function failed
Step20	Modification of the process security token to obtain SeDebugPrivileges failed
Step21	The number of currently running tampering threads exceeded 256, and SUNSPOT cannot track more threads
Step22	Unable to get a list of running processes
Step23	There was an error when enumerating the running processes list
Step30	Could not decrypt the solution name core.sln
Footnote:

1. https[:]//blog.xpnsec[.]com/how-to-argue-like-cobalt-strike/

Additional Resources
Read a blog on this topic from SolarWinds.
Download the CrowdStrike 2020 Global Threat Report.
To learn more about how to incorporate intelligence on threats into your security strategy, visit the Falcon X™  Premium Threat Intelligence page.
Get a full-featured free trial of CrowdStrike Falcon Prevent™ and learn how true next-gen AV performs against today’s most sophisticated threats.